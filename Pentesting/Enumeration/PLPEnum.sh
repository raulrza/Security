#!/bin/bash
# Author: Raul Bringas (r4mzih4x)
# PLP Enum

# This script will perform many of the manual steps during enumeration
# The idea is to build a framework that automatically peforms enumeration tasks based on findings
# Example:  If port 80 is found, perform wfuzz/gobuster, save results to file and determine what's next
# If port 21 exists an anonymous FTP connection and enumeration will be attempted, etc.
##  TODO: 
##  -Add detection for non-responsive host
##  -Run WFUZZ and jobs as backgronud processes and output PID so we can Forground on demand in different terminals
##  -Tee output to log file
##  -Continue adding port based logic for enum/attack
##  -Error and exception handling
##  -Summary of suggested attacks
##  --Leverage nmap scripts depending on scan results, searchsploit, etc.

echo ' _______   __        _______         ________'
echo '/       \ /  |      /       \       /        |'
echo '$$$$$$$  |$$ |      $$$$$$$  |      $$$$$$$$/  _______   __    __  _____  ____'
echo '$$ |__$$ |$$ |      $$ |__$$ |      $$ |__    /       \ /  |  /  |/     \/    \'
echo '$$    $$/ $$ |      $$    $$/       $$    |   $$$$$$$  |$$ |  $$ |$$$$$$ $$$$  |'
echo '$$$$$$$/  $$ |      $$$$$$$/        $$$$$/    $$ |  $$ |$$ |  $$ |$$ | $$ | $$ |'
echo '$$ |      $$ |_____ $$ |            $$ |_____ $$ |  $$ |$$ \__$$ |$$ | $$ | $$ |'
echo '$$ |      $$       |$$ |            $$       |$$ |  $$ |$$    $$/ $$ | $$ | $$ |'
echo '$$/       $$$$$$$$/ $$/             $$$$$$$$/ $$/   $$/  $$$$$$/  $$/  $$/  $$/'
echo                                                                                 
echo "-== Palapinga Enumeration and Penetration Suggestion Framework 0.1 ==-" 
echo

# Make sure the script is running as root
if [ "$(whoami)" != 'root' ]; then
        echo "You have to run $0 as root..."
        exit 1;
fi

# Prompt user for Machine Name and IP
echo "Enter the host name of the machine you wish to scan, followed by [ENTER]:"
read hostName
echo
echo "Type the IP address of the machine you wish to scan, followed by [ENTER]:"
read hostIP
echo

################################################################################
# Function Declarations				    			       #
################################################################################

enumPort21 ()
{
	echo "Starting Port 21 Enumeration..."
	if grep -q "ftp-anon" "$hostDir/nmap/$hostName.nmap"; then 
		echo "ATTENTION: FTP Papas Fritas!!!"
		echo "Anonymous FTP login enabled!"
		# Try to initiatite an anonymous ftp login via function call
		# IMPLEMENT: exploitAnonFTP()
		ftpSuggestedAttack="Anonymous FTP Login"
	fi
}

enumPort53 ()
{

	echo "Starting Port 53 Enumeration..."
	#Attempt DNS Zone Transfer
	dig @$hostIP $hostName axfr > "$hostDir/DNS-zone-xfer.log"
	echo "Port 53 enumeration results saved in '$hostDir/DNS-zone-xfer.log'"
}

enumPort79 ()
{
	echo "Starting Port 79 Enumeration..."
	finger @ $hostIP > "$hostDir/finger-enumeration.log"
	echo "Finger results stored in '$hostDir/finger-enumeration.log'"	

}

enumPort80 ()
{

	echo "Starting Port 80 Enumeration..."
	echo "Starting wfuzz on $hostIP, output saved to $hostDir/http-root_wfuzz.csv"
	wfuzz -f $hostDir/http-root_wfuzz.csv,csv -c -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt --sc 200,301 http://$hostIP/FUZZ > /dev/null 2>&1 &
	echo "Starting gobuster on $hostIP, output saved to $hostDir/http-root.log"
  	gobuster -t 100 -u http://$hostIP:80 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -o "$hostDir/http-root.log"

	# Add logic to test robots.txt and parse directories for wfuzz...
	# Thourough Mode
}



enumPort161 ()
{
	
	
	echo "Starting Port 161 Enumeration..."
	snmpwalk -c public -v1 $hostIP > "$hostDir/snmpwalk.log"
	echo "SNMP Walk results saved in '$hostDir/snmpwalk.log'..."
}


enumPort443 ()
{

	echo "Starting port 443 Enumeration..."

}


enumPort445 ()
{

	echo "Starting port 445 Enumeration..."
	smbmap -H $hostIP > "$hostDir/smb-enumeration.log"
	echo "SMB enumeration saved to '$hostDir/smb-enumeration.log'"

}


# Implement additional port logic...
#enumPort ()
#{

#}

# Grab additional paramaters to set script mode
scriptMode=$1

# Add hostName to /etc/hosts for DNS xfr
echo "$hostIP	$hostName" >> /etc/hosts
echo "An entry for $hostName has been added to /etc/hosts..."
echo

# Create directory structure for enum info
hostDir="$HOME/HTB/Machines/$hostName"
mkdir -p "$hostDir"
echo "A directory has been created for $hostName in $hostDir..."
echo

# Run the standard NMAP
mkdir -p "$hostDir/nmap"
echo "Running an NMAP scan on $hostName - $hostIP"
nmap -sC -sV -oA "$hostDir/nmap/$hostName" $hostIP #> /dev/null 2>&1
echo

#if [ $scriptMode -eq "t" ]; then 

	# Background an all ports NMAP (Only in Thorough mode)
#	echo "Running a full NMAP scan in the background..."
#	nmap -p- -oA "$hostDir/nmap/$hostName-full" $hostIP &
#	echo

	# Background a UDP nmap (Only in Thorough Mode)
#	echo "Running a full UDP NMAP scan in the background..."
#	nmap -sU -oA "$hostDir/nmap/$hostName-udp" $hostIP &
#	echo

#fi

# Gather list of open ports from NMAP scan
echo
openPorts=`grep -i open $hostDir/nmap/$hostName.nmap | cut -f1 -d/`
echo "The following ports have been detected as open:"
echo $openPorts

# For loop with Case statement to perform port based actions
for p in $openPorts; do
	case $p in
		21)
		  # Call the Port 21 enum function
		  enumPort21
		  Message="Finished Port $p tasks... Suggested Attacks: $ftpSuggestedAttack"
		  ;;
		53)
  		  # Call the port 53 enum function
		  enumPort53
		  Message="Finished port $p tasks..."
  		  ;;
	  	79)
		  # Call the port 79 enum function
		  enumPort79
 		  Message="Kicked off port $p tasks..."
		  ;;
		80)
		  # Call the port 80 enum function
		  enumPort80
		  Message="Finished port $p tasks..."
  		  ;;
	  	161)
		  # Call the port 161 enum function
		  enumPort161
		  Message="Finished port $p tasks..."
		  ;;
	  	443)
		  # Call the port 443 enum function
		  enumPort443
 		  Message="Finished port $p tasks..."
		  ;;
	  	445)
		  # Call the port 445 enum function
		  enumPort445
 		  Message="Kicked off port $p tasks..."
		  ;;
		*)
  		  # This message is printed when a new port is found
		  Message="ALERT: New port $p detected, add it to the script..."
  		  ;;
	esac

	echo $Message
done

# Parse NMAP output for any output of the versions or vulnerabilities
# Add logic and launcher for tools to be used depending on ports available to post enum functions

# Port 80
# Search for robots.txt
## Parse for any specific paths and add them to custom wordlist to fuzz (Thorough Mode)

# Port 445
# Run smbmap and other tools to grab info
# Look for available shares
